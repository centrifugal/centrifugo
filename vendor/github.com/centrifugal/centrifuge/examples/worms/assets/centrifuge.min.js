!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.Centrifuge=e()}}(function(){var e;return function t(e,n,i){function s(o,c){if(!n[o]){if(!e[o]){var u="function"==typeof require&&require;if(!c&&u)return u(o,!0);if(r)return r(o,!0);var a=new Error("Cannot find module '"+o+"'");throw a.code="MODULE_NOT_FOUND",a}var h=n[o]={exports:{}};e[o][0].call(h.exports,function(t){var n=e[o][1][t];return s(n?n:t)},h,h.exports,t,e,n,i)}return n[o].exports}for(var r="function"==typeof require&&require,o=0;o<i.length;o++)s(i[o]);return s}({1:[function(t,n,i){(function(s,r){!function(t,s){"object"==typeof i&&"undefined"!=typeof n?n.exports=s():"function"==typeof e&&e.amd?e(s):t.ES6Promise=s()}(this,function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function n(e){return"function"==typeof e}function i(e){z=e}function o(e){V=e}function c(){return function(){return s.nextTick(l)}}function u(){return"undefined"!=typeof X?function(){X(l)}:f()}function a(){var e=0,t=new K(l),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function h(){var e=new MessageChannel;return e.port1.onmessage=l,function(){return e.port2.postMessage(0)}}function f(){var e=setTimeout;return function(){return e(l,1)}}function l(){for(var e=0;W>e;e+=2){var t=Z[e],n=Z[e+1];t(n),Z[e]=void 0,Z[e+1]=void 0}W=0}function _(){try{var e=Function("return this")().require("vertx");return X=e.runOnLoop||e.runOnContext,u()}catch(t){return f()}}function d(e,t){var n=this,i=new this.constructor(p);void 0===i[te]&&M(i);var s=n._state;if(s){var r=arguments[s-1];V(function(){return P(s,i,r,n._result)})}else R(n,i,e,t);return i}function g(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(p);return E(n,e),n}function p(){}function b(){return new TypeError("You cannot resolve a promise with itself")}function v(){return new TypeError("A promises callback cannot return that same promise.")}function m(e){try{return e.then}catch(t){return re.error=t,re}}function y(e,t,n,i){try{e.call(t,n,i)}catch(s){return s}}function w(e,t,n){V(function(e){var i=!1,s=y(n,t,function(n){i||(i=!0,t!==n?E(e,n):O(e,n))},function(t){i||(i=!0,k(e,t))},"Settle: "+(e._label||" unknown promise"));!i&&s&&(i=!0,k(e,s))},e)}function S(e,t){t._state===ie?O(e,t._result):t._state===se?k(e,t._result):R(t,void 0,function(t){return E(e,t)},function(t){return k(e,t)})}function j(e,t,i){t.constructor===e.constructor&&i===d&&t.constructor.resolve===g?S(e,t):i===re?(k(e,re.error),re.error=null):void 0===i?O(e,t):n(i)?w(e,t,i):O(e,t)}function E(t,n){t===n?k(t,b()):e(n)?j(t,n,m(n)):O(t,n)}function C(e){e._onerror&&e._onerror(e._result),T(e)}function O(e,t){e._state===ne&&(e._result=t,e._state=ie,0!==e._subscribers.length&&V(T,e))}function k(e,t){e._state===ne&&(e._state=se,e._result=t,V(C,e))}function R(e,t,n,i){var s=e._subscribers,r=s.length;e._onerror=null,s[r]=t,s[r+ie]=n,s[r+se]=i,0===r&&e._state&&V(T,e)}function T(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var i=void 0,s=void 0,r=e._result,o=0;o<t.length;o+=3)i=t[o],s=t[o+n],i?P(n,i,s,r):s(r);e._subscribers.length=0}}function x(e,t){try{return e(t)}catch(n){return re.error=n,re}}function P(e,t,i,s){var r=n(i),o=void 0,c=void 0,u=void 0,a=void 0;if(r){if(o=x(i,s),o===re?(a=!0,c=o.error,o.error=null):u=!0,t===o)return void k(t,v())}else o=s,u=!0;t._state!==ne||(r&&u?E(t,o):a?k(t,c):e===ie?O(t,o):e===se&&k(t,o))}function A(e,t){try{t(function(t){E(e,t)},function(t){k(e,t)})}catch(n){k(e,n)}}function I(){return oe++}function M(e){e[te]=oe++,e._state=void 0,e._result=void 0,e._subscribers=[]}function L(){return new Error("Array Methods must be provided an Array")}function B(e){return new ce(this,e).promise}function N(e){var t=this;return new t(H(e)?function(n,i){for(var s=e.length,r=0;s>r;r++)t.resolve(e[r]).then(n,i)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function D(e){var t=this,n=new t(p);return k(n,e),n}function U(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function J(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function q(){var e=void 0;if("undefined"!=typeof r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;if(n){var i=null;try{i=Object.prototype.toString.call(n.resolve())}catch(t){}if("[object Promise]"===i&&!n.cast)return}e.Promise=ue}var F=void 0;F=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var H=F,W=0,X=void 0,z=void 0,V=function(e,t){Z[W]=e,Z[W+1]=t,W+=2,2===W&&(z?z(l):ee())},Y="undefined"!=typeof window?window:void 0,G=Y||{},K=G.MutationObserver||G.WebKitMutationObserver,$="undefined"==typeof self&&"undefined"!=typeof s&&"[object process]"==={}.toString.call(s),Q="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Z=new Array(1e3),ee=void 0;ee=$?c():K?a():Q?h():void 0===Y&&"function"==typeof t?_():f();var te=Math.random().toString(36).substring(2),ne=void 0,ie=1,se=2,re={error:null},oe=0,ce=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(p),this.promise[te]||M(this.promise),H(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?O(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&O(this.promise,this._result))):k(this.promise,L())}return e.prototype._enumerate=function(e){for(var t=0;this._state===ne&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,i=n.resolve;if(i===g){var s=m(e);if(s===d&&e._state!==ne)this._settledAt(e._state,t,e._result);else if("function"!=typeof s)this._remaining--,this._result[t]=e;else if(n===ue){var r=new n(p);j(r,e,s),this._willSettleAt(r,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(i(e),t)},e.prototype._settledAt=function(e,t,n){var i=this.promise;i._state===ne&&(this._remaining--,e===se?k(i,n):this._result[t]=n),0===this._remaining&&O(i,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;R(e,void 0,function(e){return n._settledAt(ie,t,e)},function(e){return n._settledAt(se,t,e)})},e}(),ue=function(){function e(t){this[te]=I(),this._result=this._state=void 0,this._subscribers=[],p!==t&&("function"!=typeof t&&U(),this instanceof e?A(this,t):J())}return e.prototype["catch"]=function(e){return this.then(null,e)},e.prototype["finally"]=function(e){var t=this,n=t.constructor;return t.then(function(t){return n.resolve(e()).then(function(){return t})},function(t){return n.resolve(e()).then(function(){throw t})})},e}();return ue.prototype.then=d,ue.all=B,ue.race=N,ue.resolve=g,ue.reject=D,ue._setScheduler=i,ue._setAsap=o,ue._asap=V,ue.polyfill=q,ue.Promise=ue,ue})}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:2}],2:[function(e,t,n){function i(){}var s=t.exports={};s.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.MutationObserver,n="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};var i=[];if(t){var s=document.createElement("div"),r=new MutationObserver(function(){var e=i.slice();i.length=0,e.forEach(function(e){e()})});return r.observe(s,{attributes:!0}),function(e){i.length||s.setAttribute("yes","no"),i.push(e)}}return n?(window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),i.length>0)){var n=i.shift();n()}},!0),function(e){i.push(e),window.postMessage("process-tick","*")}):function(e){setTimeout(e,0)}}(),s.title="browser",s.browser=!0,s.env={},s.argv=[],s.on=i,s.addListener=i,s.once=i,s.off=i,s.removeListener=i,s.removeAllListeners=i,s.emit=i,s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],3:[function(t,n,i){(function(){"use strict";function t(){}function i(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function s(e){return function(){return this[e].apply(this,arguments)}}var r=t.prototype,o=this,c=o.EventEmitter;r.getListeners=function(e){var t,n,i=this._getEvents();if(e instanceof RegExp){t={};for(n in i)i.hasOwnProperty(n)&&e.test(n)&&(t[n]=i[n])}else t=i[e]||(i[e]=[]);return t},r.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},r.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&(t={},t[e]=n),t||n},r.addListener=function(e,t){var n,s=this.getListenersAsObject(e),r="object"==typeof t;for(n in s)s.hasOwnProperty(n)&&-1===i(s[n],t)&&s[n].push(r?t:{listener:t,once:!1});return this},r.on=s("addListener"),r.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},r.once=s("addOnceListener"),r.defineEvent=function(e){return this.getListeners(e),this},r.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},r.removeListener=function(e,t){var n,s,r=this.getListenersAsObject(e);for(s in r)r.hasOwnProperty(s)&&(n=i(r[s],t),-1!==n&&r[s].splice(n,1));return this},r.off=s("removeListener"),r.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},r.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},r.manipulateListeners=function(e,t,n){var i,s,r=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(i=n.length;i--;)r.call(this,t,n[i]);else for(i in t)t.hasOwnProperty(i)&&(s=t[i])&&("function"==typeof s?r.call(this,i,s):o.call(this,i,s));return this},r.removeEvent=function(e){var t,n=typeof e,i=this._getEvents();if("string"===n)delete i[e];else if(e instanceof RegExp)for(t in i)i.hasOwnProperty(t)&&e.test(t)&&delete i[t];else delete this._events;return this},r.removeAllListeners=s("removeEvent"),r.emitEvent=function(e,t){var n,i,s,r,o,c=this.getListenersAsObject(e);for(r in c)if(c.hasOwnProperty(r))for(n=c[r].slice(0),s=n.length;s--;)i=n[s],i.once===!0&&this.removeListener(e,i.listener),o=i.listener.apply(this,t||[]),o===this._getOnceReturnValue()&&this.removeListener(e,i.listener);return this},r.trigger=s("emitEvent"),r.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},r.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},r._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},r._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return o.EventEmitter=c,t},"function"==typeof e&&e.amd?e(function(){return t}):"object"==typeof n&&n.exports?n.exports=t:o.EventEmitter=t}).call(this)},{}],4:[function(e,t,n){(function(n){function i(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function s(e,t){try{return e[t]}catch(n){return void 0}}function r(e,t,n){for(var i=t||{},o=2,c=arguments.length;c>o;o++){var u=arguments[o];if(void 0!==u&&null!==u)for(var a in u){var h=s(u,a),f=s(i,a);if(h!==t&&void 0!==h)if(e&&"object"==typeof h&&null!==h)if(h instanceof Array)i[a]=r(e,f instanceof Array?f:[],h);else{var l="object"!=typeof f||f instanceof Array?{}:f;i[a]=r(e,l,h)}else i[a]=h}}return i}function o(e,t){return-1!==e.indexOf(t,e.length-t.length)}function c(e,t){return 0===e.lastIndexOf(t,0)}function u(e){return"/"===e.substring(e.length-1)&&(e=e.substring(0,e.length-1)),e}function a(e){return void 0===e||null===e?!1:"string"==typeof e||e instanceof String}function h(e){return void 0===e||null===e?!1:"function"==typeof e}function f(e,t){if(n.console){var i=n.console[e];h(i)&&i.apply(n.console,t)}}function l(e,t,n){var i=.5*Math.random(),s=t*Math.pow(2,e+1);return s>n&&(s=n),Math.floor((1-i)*s)}function _(e){return"error"in e&&null!==e.error&&""!==e.error}function d(e,t){this._sockjs=null,this._isSockjs=!1,this._status="disconnected",this._reconnect=!0,this._reconnecting=!1,this._transport=null,this._transportName=null,this._transportClosed=!0,this._messageId=0,this._clientID=null,this._subs={},this._lastMessageID={},this._messages=[],this._isBatching=!1,this._isAuthBatching=!1,this._authChannels={},this._numRefreshFailed=0,this._refreshTimeout=null,this._pingInterval=null,this._pongTimeout=null,this._retries=0,this._callbacks={},this._latency=null,this._latencyStart=null,this._config={url:null,sockjs:null,retry:1e3,maxRetry:2e4,timeout:5e3,credentials:null,resubscribe:!0,ping:!0,pingInterval:3e4,pongWaitTimeout:5e3,debug:!1,insecure:!1,server:null,privateChannelPrefix:"$",onTransportClose:null,sockjsTransports:["websocket","xdr-streaming","xhr-streaming","eventsource","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"],onRefresh:null,refreshEndpoint:"/centrifuge/refresh/",refreshHeaders:{},refreshParams:{},refreshData:{},refreshTransport:"ajax",refreshAttempts:null,refreshInterval:3e3,refreshFailed:null,onPrivateChannelAuth:null,authEndpoint:"/centrifuge/auth/",authHeaders:{},authParams:{},authTransport:"ajax"},this._configure(e,t)}function g(e,t,n){this._status=y,this._error=null,this._centrifuge=e,this.channel=t,this._setEvents(n),this._isResubscribe=!1,this._recovered=!1,this._ready=!1,this._promise=null,this._noResubscribe=!1,this._initializePromise()}var p=e("es6-promise").Promise,b=e("wolfy87-eventemitter");Object.create||(Object.create=function(){var e=function(){};return function(t){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}()),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){if(!this)throw new TypeError('Array.prototype.indexOf() - can not convert "'+this+'" to object');var n=isFinite(t)?Math.floor(t):0,i=this instanceof Object?this:new Object(this),s=isFinite(i.length)?Math.floor(i.length):0;if(n>=s)return-1;if(0>n&&(n=Math.max(s+n,0)),void 0===e){do if(n in i&&void 0===i[n])return n;while(++n<s)}else do if(i[n]===e)return n;while(++n<s);return-1});var v={CONNECT:"connect",REFRESH:"refresh",SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",PUBLISH:"publish",PRESENCE:"presence",PRESENCE_STATS:"presence_stats",HISTORY:"history",PING:"ping",RPC:"rpc",MESSAGE:"message"};i(d,b),d._jsonpCallbacks={},d._jsonpTimeouts={},d._nextJSONPCallbackID=1;var m=d.prototype;m._jsonp=function(e,t,i,s,r){Object.keys(i).length>0&&this._log("Only AJAX request allows to send custom headers, it is not possible with JSONP."),this._debug("sending JSONP request to",e);var o="centrifuge_jsonp_"+d._nextJSONPCallbackID.toString();d._nextJSONPCallbackID++;var c=n.document,u=c.createElement("script"),a=setTimeout(function(){d._jsonpCallbacks[o]=function(){},r(!0,"timeout")},3e3);d._jsonpCallbacks[o]=function(e){clearTimeout(a),r(!1,e),delete d._jsonpCallbacks[o]};var h="";for(var f in t)t.hasOwnProperty(f)&&(h.length>0&&(h+="&"),h+=encodeURIComponent(f)+"="+encodeURIComponent(t[f]));var l="Centrifuge._jsonpCallbacks['"+o+"']";u.src=this._config.authEndpoint+"?callback="+encodeURIComponent(l)+"&data="+encodeURIComponent(JSON.stringify(s))+"&"+h;var _=c.getElementsByTagName("head")[0]||c.documentElement;_.insertBefore(u,_.firstChild)},m._ajax=function(e,t,i,s,r){var o=this;o._debug("sending AJAX request to",e);var c=n.XMLHttpRequest?new n.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),u="";for(var a in t)t.hasOwnProperty(a)&&(u.length>0&&(u+="&"),u+=encodeURIComponent(a)+"="+encodeURIComponent(t[a]));u.length>0&&(u="?"+u),c.open("POST",e+u,!0),"withCredentials"in c&&(c.withCredentials=!0),c.setRequestHeader("X-Requested-With","XMLHttpRequest"),c.setRequestHeader("Content-Type","application/json");for(var h in i)i.hasOwnProperty(h)&&c.setRequestHeader(h,i[h]);return c.onreadystatechange=function(){if(4===c.readyState)if(200===c.status){var e,t=!1;try{e=JSON.parse(c.responseText),t=!0}catch(n){r(!0,"JSON returned was invalid, yet status code was 200. Data was: "+c.responseText)}t&&r(!1,e)}else o._log("Couldn't get auth info from application",c.status),r(!0,c.status)},setTimeout(function(){c.send(JSON.stringify(s))},20),c},m._log=function(){f("info",arguments)},m._debug=function(){this._config.debug===!0&&f("debug",arguments)},m._websocketSupported=function(){return!("function"!=typeof WebSocket&&"object"!=typeof WebSocket)},m._sockjsEndpoint=function(){var e=this._config.url;return e=e.replace("ws://","http://").replace("wss://","https://"),e=u(e),o(this._config.url,"connection/sockjs")||(e+="/connection/sockjs"),e},m._rawWebsocketEndpoint=function(){var e=this._config.url;return e=e.replace("http://","ws://").replace("https://","wss://"),e=u(e),o(this._config.url,"connection/websocket")||(e+="/connection/websocket"),e},m._configure=function(e,t){if(this._config.url=e,this._config=r(!1,this._config,t||{}),this._debug("centrifuge config",this._config),!this._config.url)throw"Missing required configuration parameter 'url' specifying server URL";if(null!==this._config.credentials){if(!this._config.credentials.user&&""!==this._config.credentials.user){if(!this._config.insecure)throw"Missing required credentials parameter 'user' specifying user's unique ID in your application";this._debug("user not found but this is OK for insecure mode - anonymous access will be used"),this._config.user=""}if(this._config.credentials.info||(this._config.credentials.info=""),!this._config.credentials.exp){if(!this._config.insecure)throw"Missing required credentials parameter 'exp'";this._debug("exp not found but this is OK for insecure mode")}if(!this._config.credentials.sign){if(!this._config.insecure)throw"Missing required credentials parameter 'sign' specifying the sign of authentication credentials";this._debug("sign not found but this is OK for insecure mode")}}if(this._config.url=u(this._config.url),o(this._config.url,"connection/sockjs"))if(this._debug("client will connect to SockJS endpoint"),null!==this._config.sockjs)this._debug("SockJS explicitly provided in options"),this._sockjs=this._config.sockjs;else{if("undefined"==typeof SockJS)throw"include SockJS client library before Centrifuge javascript client library or provide SockJS object in options or use raw Websocket connection endpoint";this._debug("use globally defined SockJS"),this._sockjs=SockJS}else o(this._config.url,"connection/websocket")?this._debug("client will connect to raw Websocket endpoint"):(this._debug("client will detect connection endpoint itself"),null!==this._config.sockjs?(this._debug("SockJS explicitly provided in options"),this._sockjs=this._config.sockjs):"undefined"==typeof SockJS?this._debug("SockJS not found"):(this._debug("use globally defined SockJS"),this._sockjs=SockJS))},m._setStatus=function(e){this._status!==e&&(this._debug("Status",this._status,"->",e),this._status=e)},m._isDisconnected=function(){return"disconnected"===this._status},m._isConnecting=function(){return"connecting"===this._status},m._isConnected=function(){return"connected"===this._status},m._nextMessageId=function(){return++this._messageId},m._resetRetry=function(){this._debug("reset retries count to 0"),this._retries=0},m._getRetryInterval=function(){var e=l(this._retries,this._config.retry,this._config.maxRetry);return this._retries+=1,e},m._clearConnectedState=function(e){this._clientID=null;for(var t in this._callbacks)if(this._callbacks.hasOwnProperty(t)){var n=this._callbacks[t],i=n.errback;if(!i)continue;i(this._createErrorObject("disconnected"))}this._callbacks={};for(var s in this._subs)if(this._subs.hasOwnProperty(s)){var r=this._subs[s];e?(r._isSuccess()&&r._triggerUnsubscribe(),r._setSubscribing()):r._setUnsubscribed()}this._config.resubscribe&&this._reconnect||(this._subs={})},m._send=function(e){if(0!==e.length){this._debug("Send",e);var t=[];for(var n in e)message=e[n],t.push(JSON.stringify(message));this._transport.send(t.join("\n"))}},m._setupTransport=function(){var e=this;if(this._isSockjs=!1,null!==this._sockjs){var t={transports:this._config.sockjsTransports};null!==this._config.server&&(t.server=this._config.server),this._isSockjs=!0,this._transport=new this._sockjs(this._sockjsEndpoint(),null,t)}else{if(!this._websocketSupported())return void this._debug("No Websocket support and no SockJS configured, can not connect");this._transport=new WebSocket(this._rawWebsocketEndpoint())}this._transport.onopen=function(){e._transportClosed=!1,e._reconnecting=!1,e._isSockjs?(e._transportName=e._transport.transport,e._transport.onheartbeat=function(){e._restartPing()}):e._transportName="raw-websocket",e._resetRetry();var t={method:v.CONNECT};e._config.credentials&&(t.params=e._config.credentials),e._latencyStart=new Date,e._call(t).then(function(t){e._connectResponse(t)},function(t){e._disconnect("connect error",!0)})},this._transport.onerror=function(t){e._debug("transport level error",t)},this._transport.onclose=function(t){e._transportClosed=!0;var n="connection closed",i=!0;if(t&&"reason"in t&&t.reason)try{var s=JSON.parse(t.reason);e._debug("reason is an advice object",s),n=s.reason,i=s.reconnect}catch(r){n=t.reason,e._debug("reason is a plain string",n),i="disconnect"!==n}if(null!==e._config.onTransportClose&&e._config.onTransportClose({event:t,reason:n,reconnect:i}),e._disconnect(n,i),e._reconnect===!0){e._reconnecting=!0;var o=e._getRetryInterval();e._debug("reconnect after "+o+" milliseconds"),setTimeout(function(){e._reconnect===!0&&e._connect.call(e)},o)}},this._transport.onmessage=function(t){var n=t.data.split("\n");for(var i in n)if(n.hasOwnProperty(i)){if(!n[i])continue;var s=JSON.parse(n[i]);e._debug("Received",s),e._receive(s)}e._restartPing()}},m.rpc=function(e){var t={method:v.RPC,params:{data:e}},n=this._call(t);return new p(function(e,t){n.then(function(t){e(t.data)},function(e){t(e)})})},m.send=function(e){var t={method:v.MESSAGE,params:{data:e}};return this._callAsync(t)},m._callAsync=function(e){this._addMessage(e,!0)},m._call=function(e){var t=this;return new p(function(n,i){var s=t._addMessage(e);t._registerCall(s,n,i)})},m._connect=function(e){return this.isConnected()?void this._debug("connect called when already connected"):void("connecting"!==this._status&&(this._debug("start connecting"),this._setStatus("connecting"),this._clientID=null,this._reconnect=!0,e&&this.on("connect",e),this._setupTransport()))},m._disconnect=function(e,t){if(!this.isDisconnected()){this._debug("disconnected:",e,t);var n=t||!1;n===!1&&(this._reconnect=!1),this._clearConnectedState(n),this.isDisconnected()||(this._setStatus("disconnected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout),this._reconnecting===!1&&this.trigger("disconnect",[{reason:e,reconnect:n}])),this._transportClosed||this._transport.close()}},m._refreshFailed=function(){this._numRefreshFailed=0,this.isDisconnected()||this._disconnect("refresh failed",!1),null!==this._config.refreshFailed&&this._config.refreshFailed()},m._refresh=function(){var e=this;if(this._debug("refresh credentials"),0===e._config.refreshAttempts)return this._debug("refresh attempts set to 0, do not send refresh request at all"),void e._refreshFailed();null!==e._refreshTimeout&&clearTimeout(e._refreshTimeout);var t=function(t,n){return t===!0?(e._debug("error getting connection credentials from refresh endpoint",n),e._numRefreshFailed++,e._refreshTimeout&&clearTimeout(e._refreshTimeout),null!==e._config.refreshAttempts&&e._numRefreshFailed>=e._config.refreshAttempts?void e._refreshFailed():void(e._refreshTimeout=setTimeout(function(){e._refresh.call(e)},e._config.refreshInterval+Math.round(1e3*Math.random())))):(e._numRefreshFailed=0,e._config.user=n.user,e._config.timestamp=n.timestamp,"info"in n&&(e._config.info=n.info),e._config.token=n.token,void(e.isDisconnected()?(e._debug("credentials refreshed, connect from scratch"),e._connect()):(e._debug("send refreshed credentials"),e._addMessage({method:v.REFRESH,params:{user:e._config.user,timestamp:e._config.timestamp,info:e._config.info,token:e._config.token}}))))};if(null!==this._config.onRefresh){var n={};this._config.onRefresh(n,t)}else{var i=this._config.refreshTransport.toLowerCase();if("ajax"===i)this._ajax(this._config.refreshEndpoint,this._config.refreshParams,this._config.refreshHeaders,this._config.refreshData,t);else{if("jsonp"!==i)throw"Unknown refresh transport "+i;this._jsonp(this._config.refreshEndpoint,this._config.refreshParams,this._config.refreshHeaders,this._config.refreshData,t)}}},m._subscribe=function(e){var t=e.channel;if(t in this._subs||(this._subs[t]=e),!this.isConnected())return void e._setNew();e._setSubscribing();var n={method:v.SUBSCRIBE,params:{channel:t}};if(c(t,this._config.privateChannelPrefix))this._isAuthBatching?this._authChannels[t]=!0:(this.startAuthBatching(),this._subscribe(e),this.stopAuthBatching());else{var i=this._recover(t);i===!0&&(n.params.recover=!0,n.params.last=this._getLastID(t));var s=this;this._call(n).then(function(e){s._subscribeResponse(t,e)},function(e){s._subscribeError(e)})}},m._unsubscribe=function(e){this.isConnected()&&this._addMessage({method:v.UNSUBSCRIBE,params:{channel:e.channel}})},m._getSub=function(e){var t=this._subs[e];return t?t:null},m._connectResponse=function(e){if(!this.isConnected()){if(null!==this._latencyStart&&(this._latency=(new Date).getTime()-this._latencyStart.getTime(),this._latencyStart=null),e.expires){var t=e.expired;if(t)return this._reconnecting=!0,this._disconnect("expired",!0),void this._refresh()}this._clientID=e.client,this._setStatus("connected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout);var n=this;if(e.expires&&(this._refreshTimeout=setTimeout(function(){n._refresh.call(n)},1e3*e.ttl)),this._config.resubscribe){this.startBatching(),this.startAuthBatching();for(var i in this._subs)if(this._subs.hasOwnProperty(i)){var s=this._subs[i];s._shouldResubscribe()&&this._subscribe(s)}this.stopAuthBatching(),this.stopBatching(!0)}this._restartPing(),this.trigger("connect",[{client:e.client,transport:this._transportName,latency:this._latency}])}},m._stopPing=function(){null!==this._pongTimeout&&clearTimeout(this._pongTimeout),null!==this._pingInterval&&clearInterval(this._pingInterval)},m._startPing=function(){if(!(this._config.ping!==!0||this._config.pingInterval<=0)&&this.isConnected()){var e=this;this._pingInterval=setInterval(function(){return e.isConnected()?(e.ping(),void(e._pongTimeout=setTimeout(function(){e._disconnect("no ping",!0)},e._config.pongWaitTimeout))):void e._stopPing()},this._config.pingInterval)}},m._restartPing=function(){this._stopPing(),this._startPing()},m._disconnectResponse=function(e){if(_(e))this.trigger("error",[{message:e}]);else{var t=!1;"reconnect"in e.body&&(t=e.body.reconnect);var n="";"reason"in e.body&&(n=e.body.reason),this._disconnect(n,t)}},m._subscribeResponse=function(e,t){var n=this._getSub(e);if(n&&n._isSubscribing()){var i=t.publications;if(i&&i.length>0){i=i.reverse();for(var s in i)i.hasOwnProperty(s)&&this._messageResponse({body:messages[s]})}else"last"in t&&(this._lastMessageID[e]=t.last);var r=!1;"recovered"in t&&(r=t.recovered),n._setSubscribeSuccess(r)}},m._unsubscribeResponse=function(e){var t=e.uid,n=e.body,i=n.channel,s=this._getSub(i);s&&(_(e)?this.trigger("error",[{message:e}]):t||s._setUnsubscribed())},m._handleResponse=function(e){var t=e.id,n=e.result;if(t in this._callbacks){var i=this._callbacks[t];if(delete this._callbacks[t],_(e)){var s=i.errback;if(!s)return;s(e.error),this.trigger("error",[{message:e}])}else{var r=i.callback;if(!r)return;r(n)}}},m._joinResponse=function(e,t){var n=this._getSub(e);n&&n.trigger("join",[t])},m._leaveResponse=function(e,t){var n=this._getSub(e);n&&n.trigger("leave",[t])},m._messageResponse=function(e,t){this._lastMessageID[e]=t.uid;var n=this._getSub(e);n&&n.trigger("message",[t])},m._refreshResponse=function(e){if(this._refreshTimeout&&clearTimeout(this._refreshTimeout),_(e))this.trigger("error",[{message:e}]);else if(e.body.expires){var t=this,n=e.body.expired;if(n)return void(t._refreshTimeout=setTimeout(function(){t._refresh.call(t)},t._config.refreshInterval+Math.round(1e3*Math.random())));this._clientID=e.body.client,t._refreshTimeout=setTimeout(function(){t._refresh.call(t)},1e3*e.body.ttl)}},m._handleAsyncMessage=function(e){result=e.result;var t=0;"type"in result&&(t=result.type);var n=result.channel;0===t?this._messageResponse(n,result.data):1===t?this._joinResponse(n,result.data):2===t&&this._leaveResponse(n,result.data)},m._dispatchMessage=function(e){if(void 0===e||null===e)return void this._debug("dispatch: got undefined or null message");var t=e.id;t&&t>0?this._handleResponse(e):this._handleAsyncMessage(e)},m._receive=function(e){if(Object.prototype.toString.call(e)===Object.prototype.toString.call([]))for(var t in e)e.hasOwnProperty(t)&&this._dispatchMessage(e[t]);else Object.prototype.toString.call(e)===Object.prototype.toString.call({})&&this._dispatchMessage(e)},m._flush=function(){var e=this._messages.slice(0);this._messages=[],this._send(e)},m._ping=function(){this._addMessage({method:v.PING})},m._recover=function(e){return e in this._lastMessageID},m._getLastID=function(e){var t=this._lastMessageID[e];return t?(this._debug("last uid found and sent for channel",e),t):(this._debug("no last uid found for channel",e),"")},m._createErrorObject=function(e,t){var n={error:{message:e,code:t||0}};return n},m._errorObjectFromMessage=function(e){return this._createErrorObject(e.error,e.code)},m._registerCall=function(e,t,n){var i=this;this._callbacks[e]={callback:t,errback:n},setTimeout(function(){delete i._callbacks[e],h(n)&&n(i._createErrorObject("timeout"))},this._config.timeout)},m._addMessage=function(e,t){if(!t){var n=this._nextMessageId();e.id=n}return this._isBatching===!0?this._messages.push(e):this._send([e]),t?0:n},m.getClientId=function(){return this._clientID},m.isConnected=m._isConnected,m.isDisconnected=m._isDisconnected,m.connect=m._connect,m.disconnect=function(){this._disconnect("client",!1)},m.ping=m._ping,m.startBatching=function(){this._isBatching=!0},m.stopBatching=function(e){e=e||!1,this._isBatching=!1,e===!0&&this.flush()},m.flush=function(){this._flush()},m.startAuthBatching=function(){this._isAuthBatching=!0},m.stopAuthBatching=function(){var e,t;this._isAuthBatching=!1;var n=this._authChannels;this._authChannels={};var i=[];for(t in n)if(n.hasOwnProperty(t)){var s=this._getSub(t);if(!s)continue;i.push(t)}if(0!==i.length){var r={client:this.getClientId(),channels:i},o=this,c=function(n,s){if(n!==!0){var r=!1;o._isBatching||(o.startBatching(),r=!0);for(e in i)if(i.hasOwnProperty(e)){t=i[e];var c=s[t];if(!c){o._subscribeResponse({error:"channel not found in authorization response",advice:"fix",body:{channel:t}});continue}if(c.status&&200!==c.status)o._subscribeResponse({error:c.status,body:{channel:t}});else{var u={method:v.SUBSCRIBE,params:{channel:t,client:o.getClientId(),info:c.info,sign:c.sign}},a=o._recover(t);a===!0&&(u.params.recover=!0,u.params.last=o._getLastID(t)),o._call(u).then(function(e){o._subscribeResponse(t,e)},function(e){o._subscribeError(t,e)})}}r&&o.stopBatching(!0)}else{o._debug("authorization request failed");for(e in i)i.hasOwnProperty(e)&&(t=i[e],o._subscribeResponse({error:"authorization request failed",advice:"fix",body:{channel:t}}))}};if(null!==this._config.onPrivateChannelAuth)this._config.onPrivateChannelAuth({
data:r},c);else{var u=this._config.authTransport.toLowerCase();if("ajax"===u)this._ajax(this._config.authEndpoint,this._config.authParams,this._config.authHeaders,r,c);else{if("jsonp"!==u)throw"Unknown private channel auth transport "+u;this._jsonp(this._config.authEndpoint,this._config.authParams,this._config.authHeaders,r,c)}}}},m.subscribe=function(e,t){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!a(e))throw"Illegal argument type: channel must be a string";if(!this._config.resubscribe&&!this.isConnected())throw"Can not only subscribe in connected state when resubscribe option is off";var n=this._getSub(e);if(null!==n)return n._setEvents(t),n._isUnsubscribed()&&n.subscribe(),n;var i=new g(this,e,t);return this._subs[e]=i,i.subscribe(),i};var y=0,w=1,S=2,j=3,E=4;i(g,b);var C=g.prototype;C._initializePromise=function(){this._ready=!1;var e=this;this._promise=new p(function(t,n){e._resolve=function(n){e._ready=!0,t(n)},e._reject=function(t){e._ready=!0,n(t)}})},C._setEvents=function(e){if(e)if(h(e))this.on("message",e);else if(Object.prototype.toString.call(e)===Object.prototype.toString.call({}))for(var t=["message","join","leave","unsubscribe","subscribe","error"],n=0,i=t.length;i>n;n++){var s=t[n];s in e&&this.on(s,e[s])}},C._isNew=function(){return this._status===y},C._isUnsubscribed=function(){return this._status===E},C._isSubscribing=function(){return this._status===w},C._isReady=function(){return this._status===S||this._status===j},C._isSuccess=function(){return this._status===S},C._isError=function(){return this._status===j},C._setNew=function(){this._status=y},C._setSubscribing=function(){this._ready===!0&&(this._initializePromise(),this._isResubscribe=!0),this._status=w},C._setSubscribeSuccess=function(e){if(this._status!==S){this._recovered=e,this._status=S;var t=this._getSubscribeSuccessContext(e);this.trigger("subscribe",[t]),this._resolve(t)}},C._setSubscribeError=function(e){if(this._status!==j){this._status=j,this._error=e;var t=this._getSubscribeErrorContext();this.trigger("error",[t]),this._reject(t)}},C._triggerUnsubscribe=function(){this.trigger("unsubscribe",[{channel:this.channel}])},C._setUnsubscribed=function(e){this._status!==E&&(this._status=E,e===!0&&(this._noResubscribe=!0),this._triggerUnsubscribe())},C._shouldResubscribe=function(){return!this._noResubscribe},C._getSubscribeSuccessContext=function(){return{channel:this.channel,isResubscribe:this._isResubscribe,recovered:this._recovered}},C._getSubscribeErrorContext=function(){var e=this._error;return e.channel=this.channel,e.isResubscribe=this._isResubscribe,e},C.ready=function(e,t){this._ready&&(this._isSuccess()?e(this._getSubscribeSuccessContext()):t(this._getSubscribeErrorContext()))},C.subscribe=function(){return this._status!==S?(this._centrifuge._subscribe(this),this):void 0},C.unsubscribe=function(){this._setUnsubscribed(!0),this._centrifuge._unsubscribe(this)},C.publish=function(e){var t=this;return new p(function(n,i){return t._isUnsubscribed()?void i(t._centrifuge._createErrorObject("subscription unsubscribed")):void t._promise.then(function(){if(!t._centrifuge.isConnected())return void i(t._centrifuge._createErrorObject("disconnected"));var s=t._centrifuge._addMessage({method:v.PUBLISH,params:{channel:t.channel,data:e}});t._centrifuge._registerCall(s,n,i)},function(e){i(e)})})},C.presence=function(){var e=this;return new p(function(t,n){return e._isUnsubscribed()?void n(e._centrifuge._createErrorObject("subscription unsubscribed")):void e._promise.then(function(){if(!e._centrifuge.isConnected())return void n(e._centrifuge._createErrorObject("disconnected"));var i=e._centrifuge._addMessage({method:v.PRESENCE,params:{channel:e.channel}});e._centrifuge._registerCall(i,t,n)},function(e){n(e)})})},C.history=function(){var e=this;return new p(function(t,n){return e._isUnsubscribed()?void n(e._centrifuge._createErrorObject("subscription unsubscribed")):void e._promise.then(function(){if(!e._centrifuge.isConnected())return void n(e._centrifuge._createErrorObject("disconnected"));var i=e._centrifuge._addMessage({method:v.HISTORY,params:{channel:e.channel}});e._centrifuge._registerCall(i,t,n)},function(e){n(e)})})},t.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"es6-promise":1,"wolfy87-eventemitter":3}]},{},[4])(4)});

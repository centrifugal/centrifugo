package main

import (
	"bytes"
	"os"
	"strings"
	"text/template"

	"github.com/centrifugal/centrifugo/v4/internal/gen"
)

func main() {
	generateHandlers()
	generateParamsDecoder()
	generateResponseEncoder()
	generateResultEncoder()
}

type TemplateData struct {
	RequestCapitalized string
	RequestLower       string
}

func generateToFile(header, funcTmpl, outFile string) {
	tmpl := template.Must(template.New("").Parse(funcTmpl))

	var buf bytes.Buffer
	buf.WriteString(header)

	for _, req := range gen.Requests {
		err := tmpl.Execute(&buf, TemplateData{
			RequestCapitalized: req,
			RequestLower:       strings.ToLower(req),
		})
		if err != nil {
			panic(err)
		}
	}

	file, err := os.Create(outFile)
	if err != nil {
		panic(err)
	}
	defer func() {
		_ = file.Close()
	}()
	_, _ = buf.WriteTo(file)
}

var headerHandlers = `// Code generated by internal/gen/api/main.go. DO NOT EDIT.

package api

import (
	"io"
	"net/http"
)
`

var templateFuncHandlers = `
func (s *Handler) handle{{ .RequestCapitalized }}(w http.ResponseWriter, r *http.Request) {
	data, err := io.ReadAll(r.Body)
	if err != nil {
		s.handleReadDataError(r, w, err)
		return
	}

	req, err := paramsDecoder.Decode{{ .RequestCapitalized }}(data)
	if err != nil {
		s.handleUnmarshalError(r, w, err)
		return
	}

	data, err = responseEncoder.Encode{{ .RequestCapitalized }}(s.api.{{ .RequestCapitalized }}(r.Context(), req))
	if err != nil {
		s.handleMarshalError(r, w, err)
		return
	}

	s.writeJson(w, data)
}
`

func generateHandlers() {
	generateToFile(headerHandlers, templateFuncHandlers, "internal/api/handler_gen.go")
}

var headerParamsDecoder = `// Code generated by internal/gen/api/main.go. DO NOT EDIT.

package apiproto

import "encoding/json"

var _ ParamsDecoder = (*JSONParamsDecoder)(nil)

// JSONParamsDecoder ...
type JSONParamsDecoder struct{}

// NewJSONParamsDecoder ...
func NewJSONParamsDecoder() *JSONParamsDecoder {
	return &JSONParamsDecoder{}
}
`

var templateFuncParamsDecoder = `
// Decode{{ .RequestCapitalized }} ...
func (d *JSONParamsDecoder) Decode{{ .RequestCapitalized }}(data []byte) (*{{ .RequestCapitalized }}Request, error) {
	var p {{ .RequestCapitalized }}Request
	err := json.Unmarshal(data, &p)
	if err != nil {
		return nil, err
	}
	return &p, nil
}
`

func generateParamsDecoder() {
	generateToFile(headerParamsDecoder, templateFuncParamsDecoder, "internal/apiproto/decode_params_gen.go")
}

var headerResponseEncoder = `// Code generated by internal/gen/api/main.go. DO NOT EDIT.

package apiproto

import "encoding/json"

// JSONResponseEncoder ...
type JSONResponseEncoder struct{}

func NewJSONResponseEncoder() *JSONResponseEncoder {
	return &JSONResponseEncoder{}
}
`

var templateFuncResponseEncoder = `
// Encode{{ .RequestCapitalized }}
func (e *JSONResponseEncoder) Encode{{ .RequestCapitalized }}(response *{{ .RequestCapitalized }}Response) ([]byte, error) {
	//nolint:staticcheck
	return json.Marshal(response)
}
`

func generateResponseEncoder() {
	generateToFile(headerResponseEncoder, templateFuncResponseEncoder, "internal/apiproto/encode_response_gen.go")
}

var headerResultEncoder = `// Code generated by internal/gen/api/main.go. DO NOT EDIT.

package apiproto

import "encoding/json"

var _ ResultEncoder = (*JSONResultEncoder)(nil)

// JSONResultEncoder ...
type JSONResultEncoder struct{}

// NewJSONResultEncoder ...
func NewJSONResultEncoder() *JSONResultEncoder {
	return &JSONResultEncoder{}
}
`

var templateFuncResultEncoder = `
// Encode{{ .RequestCapitalized }} ...
func (e *JSONResultEncoder) Encode{{ .RequestCapitalized }}(res *{{ .RequestCapitalized }}Result) ([]byte, error) {
	return json.Marshal(res)
}
`

func generateResultEncoder() {
	generateToFile(headerResultEncoder, templateFuncResultEncoder, "internal/apiproto/encode_result_gen.go")
}

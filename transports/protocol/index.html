
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Centrifugo is a scalable real-time messaging server in language-agnostic way">
      
      
      
        <meta name="author" content="Centrifugal organization">
      
      
        <link rel="canonical" href="https://centrifugal.dev/docs/transports/client_protocol">
      
      <link rel="shortcut icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-6.2.8">
    
    
      
        <title>Client protocol - Centrifugo</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../theme/styles/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="cyan">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#client-protocol" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://centrifugal.github.io/centrifugo/" title="Centrifugo" class="md-header-nav__button md-logo" aria-label="Centrifugo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Centrifugo
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Client protocol
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    centrifugal/centrifugo
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../server/install/" class="md-tabs__link md-tabs__link--active">
        Server
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../libraries/client/" class="md-tabs__link">
        Libraries
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../faq/" class="md-tabs__link">
        FAQ
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link">
        Blog
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../pro/" class="md-tabs__link">
        Centrifugo PRO
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://centrifugal.github.io/centrifugo/" title="Centrifugo" class="md-nav__button md-logo" aria-label="Centrifugo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Centrifugo
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    centrifugal/centrifugo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
      
      <label class="md-nav__link" for="nav-2">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        What is Centrifugo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../quick_start/" class="md-nav__link">
        Quick start
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/" class="md-nav__link">
        Integration Guide
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
      
      <label class="md-nav__link" for="nav-3">
        Server
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Server" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/commands/" class="md-nav__link">
        Console commands
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/client_api/" class="md-nav__link">
        Client API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/http_api/" class="md-nav__link">
        Server HTTP API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/grpc_api/" class="md-nav__link">
        Server GRPC API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/channels/" class="md-nav__link">
        Channels
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/authentication/" class="md-nav__link">
        Authentication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/private_channels/" class="md-nav__link">
        Private channels
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/engines/" class="md-nav__link">
        Engines
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/admin/" class="md-nav__link">
        Admin web interface
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/proxy/" class="md-nav__link">
        Proxy to backend
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/server_subs/" class="md-nav__link">
        Server-side subscriptions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../server/connection_expiration/" class="md-nav__link">
        Connection expiration
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-15" type="checkbox" id="nav-3-15" checked>
      
      <label class="md-nav__link" for="nav-3-15">
        Client-server transports
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Client-server transports" data-md-level="2">
        <label class="md-nav__title" for="nav-3-15">
          <span class="md-nav__icon md-icon"></span>
          Client-server transports
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../websocket/" class="md-nav__link">
        Websocket
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sockjs/" class="md-nav__link">
        SockJS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../protobuf/" class="md-nav__link">
        Protobuf protocol
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Client protocol
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Client protocol
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#client-implementation-feature-matrix" class="md-nav__link">
    Client implementation feature matrix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-implementation-advices" class="md-nav__link">
    Client implementation advices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-side-subscriptions-sss" class="md-nav__link">
    Server side subscriptions (SSS)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-recovery" class="md-nav__link">
    Message recovery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-code-and-reason" class="md-nav__link">
    Disconnect code and reason
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-notes" class="md-nav__link">
    Additional notes
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../recovery/" class="md-nav__link">
        Message recovery
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-16" type="checkbox" id="nav-3-16" >
      
      <label class="md-nav__link" for="nav-3-16">
        Deploy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Deploy" data-md-level="2">
        <label class="md-nav__title" for="nav-3-16">
          <span class="md-nav__icon md-icon"></span>
          Deploy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/monitoring/" class="md-nav__link">
        Monitoring
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/tuning/" class="md-nav__link">
        Infrastructure tuning
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/tls/" class="md-nav__link">
        TLS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/nginx/" class="md-nav__link">
        Nginx configuration
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-17" type="checkbox" id="nav-3-17" >
      
      <label class="md-nav__link" for="nav-3-17">
        Misc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Misc" data-md-level="2">
        <label class="md-nav__title" for="nav-3-17">
          <span class="md-nav__icon md-icon"></span>
          Misc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/insecure_modes/" class="md-nav__link">
        Insecure modes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/migrate/" class="md-nav__link">
        Migrate from Centrifugo v1
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/benchmark/" class="md-nav__link">
        Benchmark
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" >
      
      <label class="md-nav__link" for="nav-4">
        Libraries
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Libraries" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          Libraries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../libraries/client/" class="md-nav__link">
        Client libraries
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../libraries/api/" class="md-nav__link">
        API libraries
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" >
      
      <label class="md-nav__link" for="nav-5">
        FAQ
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="FAQ" data-md-level="1">
        <label class="md-nav__title" for="nav-5">
          <span class="md-nav__icon md-icon"></span>
          FAQ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        Frequently Asked Questions
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
      
      <label class="md-nav__link" for="nav-6">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        About this blog
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/intro_centrifuge/" class="md-nav__link">
        An introduction to Centrifuge – real-time messaging with Go
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/quic_web_transport/" class="md-nav__link">
        Experimenting with QUIC and WebTransport in Go
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/scaling_websocket/" class="md-nav__link">
        Scaling WebSocket in Go and beyond
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" >
      
      <label class="md-nav__link" for="nav-7">
        Centrifugo PRO
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Centrifugo PRO" data-md-level="1">
        <label class="md-nav__title" for="nav-7">
          <span class="md-nav__icon md-icon"></span>
          Centrifugo PRO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pro/" class="md-nav__link">
        About
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#client-implementation-feature-matrix" class="md-nav__link">
    Client implementation feature matrix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-implementation-advices" class="md-nav__link">
    Client implementation advices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-side-subscriptions-sss" class="md-nav__link">
    Server side subscriptions (SSS)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-recovery" class="md-nav__link">
    Message recovery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disconnect-code-and-reason" class="md-nav__link">
    Disconnect code and reason
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-notes" class="md-nav__link">
    Additional notes
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/centrifugal/centrifugo/edit/master/docs/content/transports/protocol.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="client-protocol">Client protocol<a class="headerlink" href="#client-protocol" title="Permanent link">&para;</a></h1>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>This is a documentation for Centrifugo v2. The latest Centrifugo version is v3. Go to the <a href="https://centrifugal.dev">centrifugal.dev</a> for v3 docs.</p>
</div>
<p>This chapter describes internal client-server protocol in details to help developers build new client libraries and understand how existing client libraries work.</p>
<p>Note that you can always look at <a href="../../libraries/client/">existing client implementations</a> in case of any questions. Not all clients support all available server features though.</p>
<h3 id="client-implementation-feature-matrix">Client implementation feature matrix<a class="headerlink" href="#client-implementation-feature-matrix" title="Permanent link">&para;</a></h3>
<p>First we will look at list of features client library should support. Depending on client implementation some features can be not implemented. If you an author of client library you can use this list as checklist.</p>
<p>Our current client feature matrix looks like this:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> connect to server (both Centrifugo and Centrifuge-based) using JSON protocol format</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> connect to server (both Centrifugo and Centrifuge-based) using Protobuf protocol format</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> connect to server with token (JWT in Centrifugo case, any string token in Centrifuge library case)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> connect to server with custom headers (not available in a browser)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> automatic reconnect in case of dial problems (network)</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> an exponential backoff for reconnect process</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> possibility to set handlers for connect and disconnect events</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> extract and expose disconnect reason</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> subscribe on a channel and provide a way to handle asynchronous Publications coming from a channel</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> handle Join and Leave messages from a channel</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> handle Unsubscribe notifications</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> publish method of Subscription</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> unsubscribe method of Subscription</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> presence method of Subscription</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> presence stats method of Subscription</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> history method of Subscription</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> send asynchronous messages to server</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> handle asynchronous messages from server</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> send RPC requests to server</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> publish to channel without being subscribed</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> subscribe to private (token-protected) channels with token</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> connection token refresh mechanism</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> private channel subscription token refresh</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> client protocol level ping/pong to find broken connection</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> automatic reconnect in case of connect or subscribe command timeouts</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> handle connection expired error</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> handle subscription expired error</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> server-side subscriptions</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> message recovery mechanism</li>
</ul>
<p>Below I'll try to describe most of these points in detail.</p>
<p>This document describes protocol specifics for Websocket transport which supports binary and text formats to transfer data. As Centrifugo and Centrifuge library for Go have various types of messages it serializes protocol messages using JSON or Protobuf formats.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SockJS works almost the same way as JSON websocket described here but has its own extra framing on top of Centrifuge protocol messages. SockJS can only work with JSON - it's not possible to transfer binary data over it. SockJS is only needed as fallback to Websocket in web browsers.</p>
</div>
<h3 id="top-level-framing">Top level framing<a class="headerlink" href="#top-level-framing" title="Permanent link">&para;</a></h3>
<p>Centrifuge protocol defined in <a href="https://github.com/centrifugal/protocol/blob/master/definitions/client.proto">Protobuf schema</a>. That schema is a source of truth and all protocol description below describes messages from that schema.</p>
<p>Client sends <code>Command</code> to server. Server sends <code>Reply</code> to client. All communication between client and server is a bidirectional exchange of <code>Command</code> and <code>Reply</code> messages.</p>
<p>One request from client to server and one response from server to client can have more than one <code>Command</code> or <code>Reply</code>. This allows reducing number of system calls for writing and reading data.</p>
<p>When JSON format used then many <code>Command</code> can be sent from client to server in JSON streaming line-delimited format. I.e. each individual <code>Command</code> encoded to JSON and then commands joined together using new line symbol <code>\n</code>:</p>
<div class="highlight"><pre><span></span><code>{&quot;id&quot;: 1, &quot;method&quot;: &quot;subscribe&quot;, &quot;params&quot;: {&quot;channel&quot;: &quot;ch1&quot;}}
{&quot;id&quot;: 2, &quot;method&quot;: &quot;subscribe&quot;, &quot;params&quot;: {&quot;channel&quot;: &quot;ch2&quot;}}
</code></pre></div>
<p>For example here is how we do this in Javascript client when JSON format used:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">encodeCommands</span><span class="p">(</span><span class="nx">commands</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">encodedCommands</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">commands</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">commands</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">encodedCommands</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">commands</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">encodedCommands</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This doc will use JSON format for examples because it's human-readable. Everything said here for JSON is also true for Protobuf encoded case. The only difference is how several individual <code>Command</code> or server <code>Reply</code> joined into one request – see details below.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Method represented as a ENUM in protobuf schema and can be sent as integer value. Though it's possible to send it as string in JSON case – this was made to make JSON protocol human-friendly.</p>
</div>
<p>When Protobuf format used then many <code>Command</code> can be sent from client to server in length-delimited format where each individual <code>Command</code> marshaled to bytes prepended by <code>varint</code> length. See existing client implementations for encoding example.</p>
<p>The same rules relate to many <code>Reply</code> in one response from server to client. Line-delimited JSON and varint-length prefixed Protobuf also used there.</p>
<p>For example here is how we read server response and extracting individual replies in Javascript client when JSON format used:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">decodeReplies</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">replies</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">const</span> <span class="nx">encodedReplies</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">encodedReplies</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">encodedReplies</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">encodedReplies</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">reply</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">encodedReplies</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">replies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">replies</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>For Protobuf case see existing client implementations for decoding example.</p>
<p>As you can see each <code>Command</code> has <code>id</code> field. This is an incremental <code>uint32</code> field. This field will be echoed in a server replies to commands so client could match a certain <code>Reply</code> to <code>Command</code> sent before. This is important since Websocket is an asynchronous protocol where server and client both send messages at any moment and there is no builtin request-response matching. Having <code>id</code> allows matching a reply with a command send before.</p>
<p>So you can expect something like this in response after sending commands to server:</p>
<div class="highlight"><pre><span></span><code>{&quot;id&quot;: 1, &quot;result&quot;: {}}
{&quot;id&quot;: 2, &quot;result&quot;: {}}
</code></pre></div>
<p>Besides <code>id</code> <code>Reply</code> from server to client have two important fields: <code>result</code> and <code>error</code>.</p>
<p><code>result</code> contains useful payload object which is different for various <code>Reply</code> messages.</p>
<p><code>error</code> contains error description if <code>Command</code> processing resulted in some error on a server. <code>error</code> is optional and if <code>Reply</code> does not have <code>error</code> then it means that <code>Command</code> processed successfully and client can parse <code>result</code> object appropriately.</p>
<p><code>error</code> looks like this in JSON case:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;internal server error&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>We will talk more about error handling below.</p>
<p>The special type of <code>Reply</code> is <strong>asynchronous</strong> <code>Reply</code>. Such replies have no <code>id</code> field set (or <code>id</code> can be equal to zero). Async replies can come to client in any moment - not as reaction to issued <code>Command</code> but as message from server to client in arbitrary time. For example this can be a message published into channel.</p>
<p>Centrifuge library defines several command types client can issue. A well-written client must be aware of all those commands and client workflow. Communication with Centrifuge/Centrifugo server starts with issuing <code>connect</code> command.</p>
<h3 id="connect">Connect<a class="headerlink" href="#connect" title="Permanent link">&para;</a></h3>
<p>First of all client must dial with a server and then send <code>connect</code> <code>Command</code> to it.</p>
<p>Default Websocket endpoint in Centrifugo is:</p>
<div class="highlight"><pre><span></span><code>ws://centrifugo.example.com/connection/websocket
</code></pre></div>
<p>In case of using TLS:</p>
<div class="highlight"><pre><span></span><code>wss://centrifugo.example.com/connection/websocket
</code></pre></div>
<p>After a successful dial to WebSocket endpoint client must send <code>connect</code> command to server to authorize itself.</p>
<p><code>connect</code> command looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;JWT&quot;</span><span class="p">,</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Where params fields:</p>
<ul>
<li>optional string <code>token</code> - connection token. Can be ommited if token-based auth not used.</li>
<li><code>data</code> - can contain custom connect data, for example it can contain client settings.</li>
</ul>
<p>In response to <code>connect</code> command server sends a connect reply. It looks this way:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;client&quot;</span><span class="p">:</span> <span class="s2">&quot;421bf374-dd01-4f82-9def-8c31697e956f&quot;</span><span class="p">,</span>
        <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0.0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>result</code> has some fields:</p>
<ul>
<li>string <code>client</code> - unique client connection ID server issued to this connection</li>
<li>string <code>version</code> - server version</li>
<li>optional bool <code>expires</code> - whether a server will expire connection at some point</li>
<li>optional int32 <code>ttl</code> - time in seconds until connection expires</li>
</ul>
<h3 id="subscribe">Subscribe<a class="headerlink" href="#subscribe" title="Permanent link">&para;</a></h3>
<p>As soon as client successfully connected and got unique connection ID it is ready to
subscribe on channels. To do this it must send <code>subscribe</code> command to server:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Fields that can be set in <code>params</code> are:</p>
<ul>
<li>string <code>channel</code> - channel to subscribe</li>
</ul>
<p>In response to subscribe a client receives reply like:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>result</code> can have the following fields that relate to subscription expiration:</p>
<ul>
<li>optional bool <code>expires</code> - indicates whether subscription expires or not.</li>
<li>optional uint32 <code>ttl</code> - number of seconds until subscription expire.</li>
</ul>
<p>Also several fields that relate to message recovery:</p>
<ul>
<li>optional bool <code>recoverable</code> - means that messages can be recovered in this subscription.</li>
<li>optional uint64 <code>offset</code> - current publication offset inside channel</li>
<li>optional string <code>epoch</code> - current epoch inside channel</li>
<li>optional array <code>publications</code> - this is an array of missed publications in channel. When received client must call general publication event handler for each message in this array.</li>
<li>optional bool <code>recovered</code> - this flag set to <code>true</code> when server thinks that all missed publications successfully recovered and send in subscribe reply (in <code>publications</code> array) and <code>false</code> otherwise.</li>
</ul>
<p>See more about meaning of recovery related fields in <a href="../recovery/">special doc chapter</a>.</p>
<p>After a client received a successful reply on <code>subscribe</code> command it will receive asynchronous reply messages published to this channel. Messages can be of several types:</p>
<ul>
<li><code>Publication</code> message</li>
<li><code>Join</code> message</li>
<li><code>Leave</code> message</li>
<li><code>Unsub</code> message</li>
<li><code>Message</code> message</li>
<li><code>Sub</code> message</li>
</ul>
<p>See more about asynchronous messages below. </p>
<h3 id="unsubscribe">Unsubscribe<a class="headerlink" href="#unsubscribe" title="Permanent link">&para;</a></h3>
<p>When client wants to unsubscribe from a channel and therefore stop receiving asynchronous subscription messages from connection related to channel it must call <code>unsubscribe</code> command:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Actually server response does not mean a lot for a client - it must immediately remove channel subscription from internal implementation data structures and ignore all messages related to channel.</p>
<h3 id="refresh">Refresh<a class="headerlink" href="#refresh" title="Permanent link">&para;</a></h3>
<p>It's possible to turn on client connection expiration mechanism on a server. While enabled server will keep track of connections whose time of life is close to the end (connection lifetime set on connection authentication phase). In this case connection will be closed. Client can prevent closing connection refreshing its connection credentials. To do this it must send <code>refresh</code> command to server. <code>refresh</code> command is similar to <code>connect</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;refreshed token&gt;&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The tip whether a connection must be refreshed by a client comes in reply to <code>connect</code> command shown above - fields <code>expires</code> and <code>ttl</code>.</p>
<p>When client connection expire mechanism is on the value of field <code>expires</code> in connect reply is <code>true</code>. In this case client implementation should look at <code>ttl</code> value which is seconds left until connection will be considered expired. Client must send <code>refresh</code> command after this <code>ttl</code> seconds. Server gives client a configured window to refresh token after <code>ttl</code> passed and then closes connection if client have not updated its token.</p>
<p>When connecting with already expired token an error will be returned (with code <code>109</code>). In this case client should refresh its token and reconnect with exponential backoff. </p>
<h3 id="rpc-like-calls-publish-history-presence">RPC-like calls: publish, history, presence<a class="headerlink" href="#rpc-like-calls-publish-history-presence" title="Permanent link">&para;</a></h3>
<p>The mechanics of these calls is simple - client sends command and expects response from server.</p>
<p><code>publish</code> command allows to publish a message into a channel from a client.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To publish from client <code>publish</code> option in server configuration must be set to <code>true</code></p>
</div>
<p><code>history</code> allows asking a server for channel history if enabled.</p>
<p><code>presence</code> allows asking a server for channel presence information if enabled.</p>
<h3 id="asynchronous-server-to-client-messages">Asynchronous server-to-client messages<a class="headerlink" href="#asynchronous-server-to-client-messages" title="Permanent link">&para;</a></h3>
<p>There are several types of asynchronous messages that can come from server to client. All of them relate to current client subscriptions.</p>
<p>The most important message is <code>Publication</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;data&quot;</span><span class="p">:{</span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
            <span class="nt">&quot;info&quot;</span><span class="p">:{</span>
                <span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="nt">&quot;client&quot;</span><span class="p">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="nt">&quot;conn_info&quot;</span><span class="p">:{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="nt">&quot;chan_info&quot;</span><span class="p">:{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Publication</code> is a message published into channel. Note that there is no <code>id</code> field in this message - this symptom
allows to distinguish it from <code>Reply</code> to <code>Command</code>.  </p>
<p>Next message is <code>Join</code> message:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;info&quot;</span><span class="p">:{</span>
                <span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="nt">&quot;client&quot;</span><span class="p">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="nt">&quot;conn_info&quot;</span><span class="p">:{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="nt">&quot;chan_info&quot;</span><span class="p">:{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Join</code> messages sent when someone joined (subscribed on) channel.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To enable <code>Join</code> and <code>Leave</code> messages <code>join_leave</code> option must be enabled on server globally or for channel namespace.</p>
</div>
<p><code>Leave</code> messages sent when someone left (unsubscribed from) channel.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;info&quot;</span><span class="p">:{</span>
                <span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="nt">&quot;client&quot;</span><span class="p">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="nt">&quot;conn_info&quot;</span><span class="p">:{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="nt">&quot;chan_info&quot;</span><span class="p">:{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Finally <code>Unsub</code> message that means that server unsubscribed current client from a channel:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;result&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
        <span class="nt">&quot;channel&quot;</span><span class="p">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>It's possible to distinguish between different types of asynchronous messages looking at <code>type</code> field (for <code>Publication</code> this field not set or <code>0</code>).</p>
<h3 id="ping-pong">Ping Pong<a class="headerlink" href="#ping-pong" title="Permanent link">&para;</a></h3>
<p>To maintain connection alive and detect broken connections client must periodically send <code>ping</code> commands to server and expect replies to it. Ping command looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;ping&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Server just echoes this command back. When client does not receive ping reply for some time it must consider connection broken and try to reconnect. Recommended ping interval is 25 seconds, recommended period to wait for pong is 1-5 seconds. Though those numbers can vary.</p>
<h3 id="handle-disconnects">Handle disconnects<a class="headerlink" href="#handle-disconnects" title="Permanent link">&para;</a></h3>
<p>Client should handle disconnect advices from server. In websocket case disconnect advice is sent in reason field of CLOSE Websocket frame. Reason contains string which is <code>disconnect</code> object encoded into JSON (even in case of Protobuf scenario). That objects looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reconnect&quot;</span><span class="p">:</span> <span class="kc">true</span> 
<span class="p">}</span>
</code></pre></div>
<p>It contains string reason of connection closing and advice to reconnect or not. Client should take this reconnect advice into account.</p>
<p>In case of network problems and random disconnect from server without well known reason client should always try to  reconnect with exponential intervals.</p>
<h3 id="handle-errors">Handle errors<a class="headerlink" href="#handle-errors" title="Permanent link">&para;</a></h3>
<p>This section contains advices to error handling in client implementations.</p>
<p>Errors can happen during various operations and can be handled in special way in context of some commands to tolerate network and server problems.</p>
<p>Errors during <code>connect</code> must result in full client reconnect with exponential backoff strategy. The special case is error with code <code>110</code> which signals that connection token already expired. As we said above client should update its connection JWT before connecting to server again.  </p>
<p>Errors during <code>subscribe</code> must result in full client reconnect in case of internal error (code <code>100</code>). And be sent to subscribe error event handler of subscription if received error is persistent. Persistent errors are errors like <code>permission denied</code>, <code>bad request</code>, <code>namespace not found</code> etc. Persistent errors in most situation mean a mistake from developers side.</p>
<p>The special corner case is client-side timeout during <code>subscribe</code> operation. As protocol is asynchronous it's possible in this case that server will eventually subscribe client on channel but client will think that it's not subscribed. It's possible to retry subscription request and tolerate <code>already subscribed</code> (code <code>105</code>) error as expected. But the simplest solution is to reconnect entirely as this is simpler and gives client a chance to connect to working server instance.</p>
<p>Errors during rpc-like operations can be just returned to caller - i.e. user javascript code. Calls like <code>history</code> and <code>presence</code> are idempotent. You should be accurate with unidempotent operations like <code>publish</code> - in case of client timeout it's possible to send the same message into channel twice if retry publish after timeout - so users of libraries must care about this case – making sure they have some protection from displaying message twice on client side (maybe some sort of unique key in payload).</p>
<h3 id="client-implementation-advices">Client implementation advices<a class="headerlink" href="#client-implementation-advices" title="Permanent link">&para;</a></h3>
<p>Here are some advices about client public API. Examples here are in Javascript language. This is just an attempt to help in developing a client - but rules here is not obligatorily the best way to implement client.</p>
<p>Create client instance:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">centrifuge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Centrifuge</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8000/connection/websocket&quot;</span><span class="p">,</span> <span class="p">{});</span>
</code></pre></div>
<p>Set connection token (in case of using Centrifugo):</p>
<div class="highlight"><pre><span></span><code><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Connect to server:</p>
<div class="highlight"><pre><span></span><code><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</code></pre></div>
<p>2 event handlers can be set to <code>centrifuge</code> object: <code>connect</code> and <code>disconnect</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">centrifuge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Client created in <code>disconnected</code> state with <code>reconnect</code> attribute set to <code>true</code> and <code>reconnecting</code> flag set to <code>false</code> . After <code>connect()</code> called state goes to <code>connecting</code>. It's only possible to connect from <code>disconnected</code> state. Every time <code>connect()</code> called <code>reconnect</code> flag of client must be set to <code>true</code>. After each failed connect attempt state must be set to <code>disconnected</code>, <code>disconnect</code> event must be emitted (only if <code>reconnecting</code> flag is <code>false</code>), and then <code>reconnecting</code> flag must be set to <code>true</code> (if client should continue reconnecting) to not emit <code>disconnect</code> event again after next in a row connect attempt failure. In case of failure next connection attempt must be scheduled automatically with backoff strategy. On successful connect <code>reconnecting</code> flag must be set to <code>false</code>, backoff retry must be resetted and <code>connect</code> event must be emitted. When connection lost then the same set of actions as when connect failed must be performed.</p>
<p>Client must allow to subscribe on channels:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="nx">centrifuge</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="nx">eventHandlers</span><span class="p">);</span>
</code></pre></div>
<p>Subscription object created and control immediately returned to caller - subscribing must be performed asynchronously. This is required because client can automatically reconnect later so event-based model better suites for subscriptions. </p>
<p>Subscription should support several event handlers:</p>
<ul>
<li>handler for publication received from channel</li>
<li>join message handler</li>
<li>leave message handler</li>
<li>error handler</li>
<li>subscribe success event handler</li>
<li>unsubscribe event handler</li>
</ul>
<p>Every time client connects to server it must restore all subscriptions.</p>
<p>Every time client disconnects from server it must call unsubscribe handlers for all active subscriptions and then emit disconnect event.</p>
<p>Client must periodically (once in 25 secs, configurable) send ping messages to server. If pong has not beed received in 5 secs (configurable) then client must disconnect from server and try to reconnect with backoff strategy.</p>
<p>Client can automatically batch several requests into one frame to server and also must be able to handle several replies received from server in one frame.</p>
<h3 id="server-side-subscriptions-sss">Server side subscriptions (SSS)<a class="headerlink" href="#server-side-subscriptions-sss" title="Permanent link">&para;</a></h3>
<p>It's also possible to subscribe connection to channels on server side. In this case we call this server-side subscription. Client should only handle asynchronous messages coming from a server without need to create subscriptions on client side.</p>
<ul>
<li>SSS should be kept separate from client-side subs</li>
<li>SSS requires new event handlers on top-level of Client - Subscribe, Publish, Join, Leave, Unsubscribe, event handlers will be called with event context similar to client-side subs case but with <code>channel</code> field</li>
<li>Connect Reply contains SSS set by a server on connect, on reconnect client has a chance to recover missed Publications</li>
<li>Server side subscription can happen at any moment - <code>Sub</code> Push will be sent to client</li>
</ul>
<h3 id="message-recovery">Message recovery<a class="headerlink" href="#message-recovery" title="Permanent link">&para;</a></h3>
<p>Client should automatically recover messages after being disconnected due to network problems and set appropriate fields in subscribe event context. Two important fields in <code>onSubscribeSuccess</code> event context are <code>isRecovered</code> and <code>isResubscribe</code>. First field let user know what server thinks about subscription state - were all messages recovered or not. The second field must only be true if resubscribe was caused by temporary network connection lost. If user initiated resubscribe himself (calling <code>unsubscribe</code> method and then <code>subscribe</code> method) then recover workflow should not be used and <code>isResubscribe</code> must be <code>false</code>.</p>
<h3 id="disconnect-code-and-reason">Disconnect code and reason<a class="headerlink" href="#disconnect-code-and-reason" title="Permanent link">&para;</a></h3>
<p>In case of Websocket it is sent by server in CLOSE Websocket frame. This is a string containing JSON object with fields: <code>reason</code> (string) and <code>reconnect</code> (bool). Client should give users access to these fields in disconnect event and automatically follow <code>reconnect</code> advice.</p>
<h3 id="additional-notes">Additional notes<a class="headerlink" href="#additional-notes" title="Permanent link">&para;</a></h3>
<p>Centrifugo and Centrifuge-based server do not allow one client connection to subscribe on the same channel twice. In this case client will receive <code>already subscribed</code> error in reply to subscribe command.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
    
    <div class="md-footer-nav">
        <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
            
            <a href="../protobuf/" title="Protobuf protocol" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
                <div class="md-footer-nav__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
                </div>
                <div class="md-footer-nav__title">
                    <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                        Protobuf protocol
                    </div>
                </div>
            </a>
            
            
            <a href="../recovery/" title="Message recovery" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
                <div class="md-footer-nav__title">
                    <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                        Message recovery
                    </div>
                </div>
                <div class="md-footer-nav__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
                </div>
            </a>
            
        </nav>
    </div>
    
    <div class="md-footer-meta md-typeset">
        <div class="md-footer-meta__inner md-grid">
            <div class="md-footer-copyright">
                
                <div class="md-footer-copyright__highlight">
                    Copyright &copy; 2020 Centrifugal
                </div>
                
                <style>

                    /* Preserve link color */
                    .md-announce a,
                    .md-announce a:focus,
                    .md-announce a:hover {
                        color: currentColor;
                    }

                    /* Don't wrap name of blog article */
                    .md-announce strong {
                        white-space: nowrap;
                    }

                    /* Twitter icon */
                    .md-announce .twitter {
                        margin-left: .2em;
                        color: #00acee;
                    }
                </style>
                <a href="https://opencollective.com/centrifugal">
                    Support Centrifugo development on <strong>Open Collective</strong>
                </a>
            </div>
            
        </div>
    </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>
